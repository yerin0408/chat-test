<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DM ì±„íŒ… í…ŒìŠ¤íŠ¸ + ì´ë¯¸ì§€ + ìƒíƒœ</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        #chatBox { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 8px; margin-bottom: 10px; }
        li { margin-bottom: 5px; list-style: none; }
        .status { font-size: 14px; color: gray; margin-left: 10px; }
    </style>
</head>
<body>

<h2> DM ì±„íŒ… í…ŒìŠ¤íŠ¸ (ì´ë¯¸ì§€ í¬í•¨ + ì ‘ì† ìƒíƒœ)</h2>
<div>
    ë‚´ ID: <input type="text" id="myId" value="yr04082" />
    ë‚´ ë‹‰ë„¤ì„: <input type="text" id="myNickname" value="yr04082" /><br/>
    ìƒëŒ€ ID: <input type="text" id="opponentId" value="yr0408" />
    ìƒëŒ€ ë‹‰ë„¤ì„: <input type="text" id="opponentNickname" value="yr0408" />
    <span id="onlineStatus" class="status">â³ ìƒíƒœ í™•ì¸ ì¤‘...</span>
    <button onclick="createOrEnterDmRoom()">ì±„íŒ… ì‹œì‘</button>
</div>

<ul id="chatBox"></ul>
<input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
<input type="file" id="imageInput" accept="image/*" />
<button onclick="sendMessage()">ì „ì†¡</button>

<script>
    let stompClient = null;
    let currentRoomId = null;
    const BASE_URL = "http://223.130.159.146:8080";

    function appendMessage(prefix, msg) {
        const li = document.createElement("li");
        if (msg.messageType === "IMAGE") {
            li.innerHTML = `${prefix}: ${msg.senderNickname} <br/><img src="${msg.content}" width="150" />`;
        } else {
            li.textContent = `${prefix}: ${msg.senderNickname} - ${msg.content}`;
        }
        document.getElementById("chatBox").appendChild(li);
        document.getElementById("chatBox").scrollTop = document.getElementById("chatBox").scrollHeight;
    }

    function updateOpponentOnlineStatus(myId, opponentId) {
        fetch("${BASE_URL}/api/chat/rooms", {
            headers: { "X-USER-ID": myId }
        })
            .then(res => res.json())
            .then(rooms => {
                const room = rooms.find(r => r.opponentId === opponentId);
                if (room) {
                    document.getElementById("onlineStatus").innerText = room.online ? "ğŸŸ¢ ì˜¨ë¼ì¸" : "âš« ì˜¤í”„ë¼ì¸";
                } else {
                    document.getElementById("onlineStatus").innerText = "â“ ì •ë³´ ì—†ìŒ";
                }
            });
    }

    function createOrEnterDmRoom() {
        const myId = document.getElementById("myId").value;
        const opponentId = document.getElementById("opponentId").value;
        const myNickname = document.getElementById("myNickname").value;
        const opponentNickname = document.getElementById("opponentNickname").value;

        fetch("${BASE_URL}/api/chat/dm-room", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-USER-ID": myId
            },
            body: JSON.stringify({
                myNickname,
                opponentId,
                opponentNickname
            })
        })
            .then(res => res.json())
            .then(data => {
                currentRoomId = data.roomId;
                connectWebSocket(myId);
                loadMessages(myId);
                updateOpponentOnlineStatus(myId, opponentId);
            });
    }

    function connectWebSocket(userId) {
        const socket = new SockJS("/ws/chat/websocket");
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({ "X-USER-ID": userId }, () => {
            stompClient.subscribe(`/topic/chat.${currentRoomId}`, (msg) => {
                const m = JSON.parse(msg.body);
                appendMessage("ì‹¤ì‹œê°„", m);
            });
        });
    }

    function loadMessages(userId) {
        fetch(`${BASE_URL}/api/chat/rooms/${currentRoomId}/messages`, {
            headers: { "X-USER-ID": userId }
        })
            .then(res => res.json())
            .then(data => {
                data.content.forEach(m => appendMessage("ì´ì „", m));
            });
    }

    function sendMessage() {
        const myId = document.getElementById("myId").value;
        const myNickname = document.getElementById("myNickname").value;
        const content = document.getElementById("messageInput").value;
        const file = document.getElementById("imageInput").files[0];

        if (file) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("roomId", currentRoomId);

            fetch("${BASE_URL}/api/chat/images", {
                method: "POST",
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    sendPayload({
                        roomId: currentRoomId,
                        senderId: myId,
                        senderNickname: myNickname,
                        content: data.url,
                        messageType: "IMAGE"
                    });
                    document.getElementById("imageInput").value = "";
                });
        }

        if (content.trim()) {
            sendPayload({
                roomId: currentRoomId,
                senderId: myId,
                senderNickname: myNickname,
                content,
                messageType: "TEXT"
            });
            document.getElementById("messageInput").value = "";
        }
    }

    function sendPayload(payload) {
        stompClient.send(`/app/chat.send.${currentRoomId}`, {}, JSON.stringify(payload));
    }
</script>

</body>
</html>
